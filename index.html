<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ú†Øª Ú©ÙˆØ¯Ú©Ø§Ù†Ù‡</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, interactive-widget=resizes-content" />
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
/* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ */
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html,body{ margin:0; padding: 0; width: 100%; height: 100%; overflow: hidden; overscroll-behavior: none; }
.bg-img{ position:fixed; top: 0; left: 0; width: 100%; height: 100dvh; object-fit:cover; z-index:-1; filter:none !important; opacity:1 !important; pointer-events: none; }
body{ direction:rtl; font-family:Vazirmatn,Tahoma; background: transparent; }
.chat{ max-width:480px; height: 100dvh; margin:auto; display:flex; flex-direction:column; background:transparent; position: relative; }
.header, .messages, .controls{ background:transparent !important; backdrop-filter:none !important; filter:none !important; opacity:1 !important; }
.header{ text-align:center; padding:14px; font-size:20px; font-weight:600; color:#fff; text-shadow: 0 1px 3px rgba(0,0,0,0.6); background: linear-gradient(90deg, rgba(255,152,0, 0.7), rgba(255,183,3, 0.7)); flex-shrink: 0; }
.messages{ flex:1; padding:12px; overflow-y:auto; width: 100%; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
.msg{ max-width:85%; padding:10px 14px; margin:6px 0; border-radius:16px; font-size:15px; overflow: hidden; display: flex; box-shadow: 0 1px 3px rgba(0,0,0,0.1); word-wrap: break-word; flex-direction: column; align-items: flex-start; gap: 5px; }
.msg p { margin: 0; }
.msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
.bot{ background:rgba(255, 213, 155, 0.95); margin-right:auto; color: #333; }
.user{ background:rgba(255, 255, 255, 0.95); margin-left:auto; color: #000; }
.controls{ padding:10px; padding-bottom: max(10px, env(safe-area-inset-bottom)); background: rgba(255, 255, 255, 0.9); border-top: 1px solid #eee; flex-shrink: 0; }
.buttons{ display:flex; gap:8px; margin-bottom:8px; }
.buttons button{ flex:1; background:#ffb703; border:none; padding:12px; font-size:16px; border-radius:14px; cursor:pointer; transition: background-color 0.2s; color: #333; font-weight: bold; }
.buttons button:hover { background: #ffaa00; }
.input-row{ display:flex; gap:6px; align-items: center; }
input{ flex:1; padding:12px; border-radius:12px; border:1px solid #ccc; transition: all 0.2s; font-family:Vazirmatn,Tahoma; font-size: 16px; }
.send, .camera-btn { background:#ff9800; color:#fff; border:none; padding:12px 16px; border-radius:12px; font-size: 16px; cursor: pointer; white-space: nowrap; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
.send:hover, .camera-btn:hover { background: #ff7800; }
iframe, video { width: 100%; border-radius:12px; border:0; margin-top:6px; background: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø®Ø´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ */
#preview-container {
    display: none; 
    background: rgba(255, 240, 200, 0.8);
    padding: 8px;
    margin-bottom: 8px;
    border-radius: 12px;
    align-items: center;
    justify-content: space-between;
    border: 1px dashed #ff9800;
}
#preview-img {
    height: 50px;
    border-radius: 6px;
    border: 1px solid #fff;
}
.preview-info {
    font-size: 13px;
    color: #555;
    flex: 1;
    margin-right: 10px;
}
.close-preview {
    background: #ff5252;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
</head>

<body>
<img src="https://i.postimg.cc/m2khRtHb/IMG-20251230-162019-034.png" class="bg-img" alt="Background" />
<div class="chat">
  <div class="header">ğŸŒˆ Ú†Øª Ú©ÙˆØ¯Ú©Ø§Ù†Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯</div>
  <div id="messages" class="messages">
    <div class="msg bot">Ø³Ù„Ø§Ù…! Ù…Ù† Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§Ù… Ø¨Ø§Ù‡Ø§Øª Ø­Ø±Ù Ø¨Ø²Ù†Ù…ØŒ Ù†Ù‚Ø§Ø´ÛŒ Ø¨Ú©Ø´Ù… ÛŒØ§ Ø¨Ø±Ø§Øª Ù‚ØµÙ‡ Ø¨Ø°Ø§Ø±Ù…! ğŸ¤–</div>
  </div>
  <div class="controls">
    
    <!-- Ø¨Ø®Ø´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ -->
    <div id="preview-container">
        <div style="display:flex; align-items:center;">
            <img id="preview-img" src="" alt="preview">
            <span class="preview-info">Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯!</span>
        </div>
        <button class="close-preview" onclick="clearImage()">Ã—</button>
    </div>

    <div class="buttons">
      <button onclick="showMusic()">ğŸµ Ø¢Ù‡Ù†Ú¯</button>
      <button onclick="playNextStoryFolder()">ğŸ“š Ù‚ØµÙ‡</button>
    </div>
    <div id="input-row" class="input-row">
      <input id="text" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³... (ÛŒØ§ Ø¨Ú¯Ùˆ Ø¨Ú©Ø´)" autocomplete="off" />
      
      <!-- Ø¯Ú©Ù…Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ù‡Ù… Ø¯ÙˆØ±Ø¨ÛŒÙ† Ùˆ Ù‡Ù… Ú¯Ø§Ù„Ø±ÛŒ Ø±Ø§ Ø¨Ø§Ø² Ù…ÛŒâ€ŒÚ©Ù†Ø¯ -->
      <button class="camera-btn" onclick="openCamera()">ğŸ“¸</button> 
      <button class="send" onclick="send()">Ø§Ø±Ø³Ø§Ù„</button>
      
      <!-- Ø­Ø°Ù capture="user" Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø³ÛŒØ³ØªÙ… Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„ Ø¨Ø§Ø² Ø´ÙˆØ¯ -->
      <input type="file" id="imageUpload" accept="image/*" style="display: none;" />
    </div>
  </div>
</div>

<script>
const messages=document.getElementById("messages");
const text=document.getElementById("text");
const imageUpload = document.getElementById("imageUpload");
const previewContainer = document.getElementById("preview-container");
const previewImg = document.getElementById("preview-img");

// Ù…ØªØºÛŒØ± Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¹Ú©Ø³
let pendingImageBase64 = null;

// === Ø¨Ø®Ø´ Ù¾Ø®Ø´ ÙˆÛŒØ¯ÛŒÙˆ ===
const folderNames = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""); 
let currentFolderIdx = 0;

function playNextStoryFolder() {
    if (currentFolderIdx >= folderNames.length) {
        currentFolderIdx = 0;
        addBot("ğŸ‰ Ù‚ØµÙ‡â€ŒÙ‡Ø§ ØªÙ…ÙˆÙ… Ø´Ø¯! Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø² Ø§ÙˆÙ„ Ù…ÛŒØ°Ø§Ø±Ù….");
    }
    const folder = folderNames[currentFolderIdx];
    playLocalVideo(folder, 1); 
    currentFolderIdx++; 
}

function playLocalVideo(folderName, partNum) {
    const fileName = partNum + ".mp4"; 
    const videoPath = folderName + "/" + fileName; 
    const vidId = "vid_" + folderName + "_" + partNum;

    let caption = "ğŸ¿ Ø¨ÙØ±Ù…Ø§ Ø§ÛŒÙ†Ù… ÛŒÙ‡ Ù‚ØµÙ‡ Ù‚Ø´Ù†Ú¯!";
    if(partNum === 2) caption = "Ù‚Ø³Ù…Øª Ø¨Ø¹Ø¯ÛŒ... ğŸ‘‡";

    addBotHTML(`
        ${caption}<br>
        <video id="${vidId}" controls autoplay playsinline>
           <source src="${videoPath}" type="video/mp4">
        </video>
    `);

    setTimeout(() => {
        const vid = document.getElementById(vidId);
        if(vid) {
            vid.onended = function() {
                if (partNum === 1) {
                    playLocalVideo(folderName, 2); 
                } else {
                    addBotHTML(`ØªÙ…ÙˆÙ… Ø´Ø¯! ğŸ`);
                }
            };
            vid.onerror = function() {
                addBotHTML(`âŒ Ø§ÛŒ ÙˆØ§ÛŒ! ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§Ø² Ù†Ø´Ø¯. (Ù…Ø³ÛŒØ± ÙØ§ÛŒÙ„: ${videoPath})`);
            };
        }
    }, 500);
}
// =================================

const SYSTEM_PROMPT = `You are a helpful assistant for children. Speak Persian. Be funny. Use emojis.`;
let chatHistory = [{ role: "system", content: SYSTEM_PROMPT }];
function getRandomSeed() { return Math.floor(Math.random() * 1000000); }
function scrollToBottom() { messages.scrollTop = messages.scrollHeight; }
function addUser(t) { const d = document.createElement("div"); d.className = "msg user"; d.textContent = t; messages.appendChild(d); scrollToBottom(); }
function addImageMessage(src) { const d = document.createElement("div"); d.className = "msg user"; d.innerHTML = `<img src="${src}" style="max-width:100%; border-radius:10px;">`; messages.appendChild(d); scrollToBottom(); }
function addBot(t) { const d = document.createElement("div"); d.className = "msg bot"; d.textContent = t; messages.appendChild(d); scrollToBottom(); return d; }
function addBotHTML(h) { const d = document.createElement("div"); d.className = "msg bot"; d.innerHTML = h; messages.appendChild(d); scrollToBottom(); return d; }

function openCamera() { imageUpload.click(); }

// Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
imageUpload.addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            pendingImageBase64 = e.target.result;
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú©Ø§Ø¯Ø± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            previewImg.src = pendingImageBase64;
            previewContainer.style.display = 'flex';
            text.placeholder = "Ú†ÛŒØ²ÛŒ Ø±Ø§Ø¬Ø¹ Ø¨Ù‡ Ø¹Ú©Ø³ Ø¨Ù†ÙˆÛŒØ³ (ÛŒØ§ Ø®Ø§Ù„ÛŒ Ø¨ÙØ±Ø³Øª)...";
            text.focus();
        };
        reader.readAsDataURL(file);
    }
    imageUpload.value = ""; // Ø±ÛŒØ³Øª
});

function clearImage() {
    pendingImageBase64 = null;
    previewContainer.style.display = 'none';
    previewImg.src = "";
    text.placeholder = "Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³... (ÛŒØ§ Ø¨Ú¯Ùˆ Ø¨Ú©Ø´)";
}

const musicItems = ["kuwwa96","qix33s7","vel4b45","rlp19p7","nswr01v","rdnfzu8","hlhhk2c","lrp8joa","hmjtu5n","tsc4j02","sqjgq6y","wprdfan","lqi28rn","rbx5yog","ium705m","asd84h5","tzbmcv0","osc7jqw","lym9zw9","txu4t6u","smy989m","per067p","imo37bl","ttfw8jw","ulqgk06","jqc6uu8","qayifn7","zrntnb2","ayv587u","nvbu340","uyht078","cpl72h8","wfa2prl","cyz06r4","kys3c8g","tmk0p3k","awj4t0t","pci839t","u24qxc6","Kg1Ww","nez63x2","myoo7e4","axb736y","ksr7t9m","tlkiz84","ofpx6ty","qdfff01","wwx5qjo","vvj06m7","wxr9p44","art7m29","ykul3ps","jomai8a","daar265","wjc1623","orar1w3","ixmh9fc","tabjtjb","rhnn8dy","pcbku25","jsszx26","DieLV","eyx5820","htu7z82","acuvfl8","mlna208","zit77o6","bnr540u","bit4wtp","aoa5q3s","xuvjxmq","9wJhI","ewrkgiv","y976lgg","hgb43fh","sog5y2j","jcjc65z","MGmE3","12GXo","fgw0840","gyegxvk","k39fin9","hyomk6m","z25b666","2HOXR","2i31N","e11x343","qddef27","bftmb4b","jxh4d7j","fmv51mf","gavji9h","nbi5o09","bax6b6l","wcv102q","fay4o4s","ega98k0","nov9rlu","dtn7h6n"];
let i = 0;
function showMusic() {
    let code = musicItems[i];
    addBotHTML(`ğŸµ Ø¨ÙØ±Ù…Ø§ Ø¢Ù‡Ù†Ú¯:<br><iframe src="https://www.aparat.com/video/video/embed/videohash/${code}/vt/frame" allowfullscreen></iframe>`);
    i = (i + 1) % musicItems.length;
}

// ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø§Ø±Ø³Ø§Ù„
async function send() {
    let v = text.value.trim();
    
    // Ø§Ú¯Ø± Ù†Ù‡ Ù…ØªÙ†ÛŒ Ù‡Ø³Øª Ùˆ Ù†Ù‡ Ø¹Ú©Ø³ÛŒØŒ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
    if (!v && !pendingImageBase64) return;
    
    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú†Øª (Ø³Ù…Øª Ú©Ø§Ø±Ø¨Ø±)
    if (pendingImageBase64) {
        addImageMessage(pendingImageBase64);
    }
    if (v) {
        addUser(v);
    }

    // Ø°Ø®ÛŒØ±Ù‡ Ù…ÙˆÙ‚Øª Ø¯ÛŒØªØ§ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„
    const imageToSend = pendingImageBase64;
    const textToSend = v;

    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
    text.value = "";
    clearImage(); // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´

    // Ù„Ø§Ø¬ÛŒÚ© Ø®Ø§Øµ: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¢Ù‡Ù†Ú¯
    const lowerV = textToSend.toLowerCase();
    if (lowerV.includes("Ø¢Ù‡Ù†Ú¯")) { showMusic(); return; }
    
    // Ù„Ø§Ø¬ÛŒÚ© Ø®Ø§Øµ: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‚ØµÙ‡
    if (lowerV.includes("Ù‚ØµÙ‡") || lowerV.includes("Ú©Ø§Ø±ØªÙˆÙ†")) { playNextStoryFolder(); return; }

    // Ù„Ø§Ø¬ÛŒÚ© Ø®Ø§Øµ: Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ù‚Ø§Ø´ÛŒ (Ø§Ú¯Ø± ÙÙ‚Ø· Ù…ØªÙ† Ø¨Ø§Ø´Ø¯)
    if (!imageToSend && (lowerV.includes('Ø¨Ú©Ø´') || lowerV.includes('draw'))) {
        const loadingMsg = addBot("Ø¯Ø±Ø­Ø§Ù„ Ù†Ù‚Ø§Ø´ÛŒ... ğŸ¨");
        try {
            const prompt = `cute cartoon style, pixar style, 3d render, ${textToSend}`;
            const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?seed=${getRandomSeed()}&nologo=true`;
            const img = new Image();
            img.onload = () => { messages.removeChild(loadingMsg); addBotHTML(`Ø¨ÙØ±Ù…Ø§:<br><img src="${url}" />`); };
            img.src = url;
        } catch (e) { messages.removeChild(loadingMsg); addBot("Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯!"); }
        return;
    }

    // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Ù…ØªÙ†ÛŒ ÛŒØ§ ØªØµÙˆÛŒØ±ÛŒ)
    const loadingMsg = addBot("..."); 
    
    // Ø³Ø§Ø®ØªØ§Ø± Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ÛŒ
    let newMessageContent;
    if (imageToSend) {
        // Ø§Ú¯Ø± Ø¹Ú©Ø³ Ø¯Ø§Ø±ÛŒÙ…
        newMessageContent = [
            { type: "text", text: textToSend || "ØªØ­Ù„ÛŒÙ„ Ø§ÛŒÙ† Ø¹Ú©Ø³" },
            { type: "image_url", image_url: { url: imageToSend } }
        ];
    } else {
        // ÙÙ‚Ø· Ù…ØªÙ†
        newMessageContent = textToSend;
        chatHistory.push({ role: "user", content: textToSend });
    }

    try {
        const response = await fetch('https://text.pollinations.ai/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                messages: imageToSend 
                    ? [{ role: "system", content: SYSTEM_PROMPT }, { role: "user", content: newMessageContent }] // Ø¨Ø±Ø§ÛŒ Ø¹Ú©Ø³ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ù…ÛŒâ€ŒÙØ±Ø³ØªÛŒÙ… ØªØ§ Ø³Ø¨Ú© Ø¨Ù…Ø§Ù†Ø¯
                    : chatHistory,
                seed: getRandomSeed(),
                model: 'openai'
            })
        });
        const data = await response.text();
        
        if (!imageToSend) {
             chatHistory.push({ role: "assistant", content: data });
        }
        
        messages.removeChild(loadingMsg);
        addBotHTML(marked.parse(data)); 
    } catch (error) {
        messages.removeChild(loadingMsg);
        addBot("Ø§ÛŒÙ†ØªØ±Ù†ØªØª ÙˆØµÙ„Ù‡ØŸ");
    }
}

text.addEventListener('keypress', (e) => { if (e.key === 'Enter') send(); });
</script>
</body>
</html>
